<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
        />

        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta charset="utf-8" />

        <title>teh DSP</title>
    </head>

    <body>
        <div class="container mc_pane" id="pane1">
            <div class="section">
                <div class="row">
                    <form class="col s12">
                        <div class="row">
                            <div class="input-field col s12">
                                <label for="masterVolume">Master volume</label><br />
                                <p class="range-field">
                                    <input
                                        type="range"
                                        id="masterVolume"
                                        min="0"
                                        max="100"
                                        value="0"
                                        class="update_masterVolume"
                                        disabled
                                    />
                                </p>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="row">
                    <div class="col s12 m6 l6 btn_grid">
                        <a class="btn waves-effect waves-light nappi blue" name="action" data-mode="off"
                            >Nappi
                            <i class="material-icons right">done</i>
                            <!--
                            <i class="material-icons right">volume_up</i>
                            <i class="material-icons right">volume_off</i>
                            -->
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <script type="text/javascript">
            (function ($) {
                $(function () {
                    //var host = window.location.hostname;
                    var host = "192.168.8.187";
                    var ws_url = "ws://" + host + ":81";
                    var connection;
                    var ws_waiting = 0;

                    function init() {
                        connection = new WebSocket(ws_url);

                        connection.onopen = function () {
                            console.log("WebSocket Open");
                            heartbeat();
                        };

                        connection.onerror = function (error) {
                            console.log("WebSocket Error " + error);
                        };

                        connection.onmessage = function (e) {
                            console.log("WebSocket from server: " + e.data);
                            ws_waiting = 0;
                            var obj = null;
                            try {
                                obj = JSON.parse(e.data);
                            } catch (err) {}
                            if (obj) {
                                // console.log(obj);
                                if (obj.volume !== undefined) {
                                    var volume = parseInt((obj.volume * 100) / 0x00800000);
                                    $("#masterVolume").val(volume);
                                    $("#masterVolume").prop("disabled", false);
                                }
                            }
                        };

                        $.getJSON("http://" + host + "/get_values", function (obj) {
                            console.log("get_values", obj);
                            var volume = parseInt((obj.masterVolume1 * 100) / 0x00800000);
                            $("#masterVolume").val(volume);
                        });
                    }

                    $("#pane1").on("input", ".update_masterVolume", function () {
                        var value = $("#masterVolume").val();

                        wsSendCommand("masterVolume: " + parseInt((value * 0x00800000) / 100));
                    });

                    $("#pane1").on("click", ".nappi", function () {
                        console.log("nappi");

                        wsSendCommand("nappi");
                    });

                    function wsSendCommand(cmd) {
                        console.log("Send WebSocket command:", cmd);
                        if (ws_waiting == 0) {
                            connection.send(cmd);
                            ws_waiting++;
                        } else {
                            console.log("++++++++ WS call waiting, skip");
                        }
                    }

                    function heartbeat() {
                        if (!connection) return;
                        if (connection.readyState !== 1) return;
                        connection.send("heartbeat");
                        setTimeout(heartbeat, 10000);
                    }

                    init();
                });
            })(jQuery);
        </script>
    </body>
</html>
