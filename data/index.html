<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
        />

        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta charset="utf-8" />

        <title>teh DSP</title>
    </head>

    <body>
        <div class="container mc_pane" id="pane1">
            <div class="section">
                <div class="row">
                    <form class="col s12">
                        <div class="row">
                            <div class="input-field col s12">
                                <label for="masterVolume">Master volume</label><br />
                                <p class="range-field">
                                    <input
                                        type="range"
                                        id="masterVolume"
                                        min="0"
                                        max="100"
                                        value="0"
                                        class="update_masterVolume"
                                        disabled
                                    />
                                </p>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- TODO: connect/disconnect adau1701 i2c -->
                <div class="row">
                    <div class="col s12 m6 l6 btn_grid">
                        <a class="btn waves-effect waves-light connection blue" name="action" data-mode="off">
                            <span id="button_connect">
                                Connect
                                <i class="material-icons right">sync</i>
                            </span>
                            <span id="button_disconnect" class="hide">
                                Disconnect
                                <i class="material-icons right">sync_disabled</i>
                            </span>
                        </a>
                        <a class="btn waves-effect waves-light mute blue" name="action" data-mode="off">
                            <span id="button_muted">
                                Mute
                                <i class="material-icons right">volume_off</i>
                            </span>
                            <span id="button_unmuted" class="hide">
                                Unmute
                                <i class="material-icons right">volume_up</i>
                            </span>
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m6 l6 btn_grid">
                        <a class="btn waves-effect waves-light power blue" name="action" data-mode="off">
                            <span id="button_power_on">
                                Power on
                                <i class="material-icons right">flash_on</i>
                            </span>
                            <span id="button_power_off" class="hide">
                                Power off
                                <i class="material-icons right">flash_off</i>
                            </span>
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m6 l6 btn_grid">
                        <a class="btn waves-effect waves-light nappi blue" name="action" data-mode="off"
                            >Nappi
                            <i class="material-icons right">done</i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="section">
                <a href="config">Config</a>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <script type="text/javascript">
            (function ($) {
                $(function () {
                    //var host = window.location.hostname;
                    var host = "192.168.8.187";
                    var ws_url = "ws://" + host + ":81";
                    var connection;
                    var ws_waiting = 0;

                    var is_connected = false;
                    var power_status = false;

                    function init() {
                        connection = new WebSocket(ws_url);

                        connection.onopen = function () {
                            console.log("WebSocket Open");
                            heartbeat();
                        };

                        connection.onerror = function (error) {
                            console.log("WebSocket Error " + error);
                            disconnected();
                        };

                        connection.onmessage = function (e) {
                            console.log("WebSocket from server: " + e.data);
                            ws_waiting = 0;
                            var obj = null;
                            try {
                                obj = JSON.parse(e.data);
                            } catch (err) {}
                            if (obj) {
                                // console.log(obj);
                                if (obj.volume !== undefined) {
                                    var volume = parseInt((obj.volume * 100) / 0x00800000);
                                    $("#masterVolume").val(volume);
                                }
                            }
                        };

                        $.getJSON("http://" + host + "/connection", function (obj_conn) {
                            if (obj_conn.connected === true) {
                                getValues();
                            }
                        });

                        $.getJSON("http://" + host + "/switch", function (obj) {
                            if (obj.switch !== undefined && obj.switch !== null) {
                                handlePower(obj.switch);
                            }
                        });
                    }

                    function getValues() {
                        $.getJSON("http://" + host + "/get_values", function (obj) {
                            console.log("get_values", obj);
                            var volume = parseInt((obj.masterVolume1 * 100) / 0x00800000);
                            $("#masterVolume").val(volume);
                            handleConnection(true);
                        });
                    }

                    function connect() {
                        $.getJSON("http://" + host + "/connection?state=1", function (obj_conn) {
                            if (obj_conn.connected === true) {
                                getValues();
                            }
                        });
                    }

                    function handleConnection(state) {
                        is_connected = state;
                        if (state === true) {
                            $("#button_connect").addClass("hide");
                            $("#button_disconnect").removeClass("hide");
                            $("#masterVolume").prop("disabled", false);
                        } else {
                            $("#button_connect").removeClass("hide");
                            $("#button_disconnect").addClass("hide");
                            disconnected();
                        }
                    }

                    function disconnected() {
                        is_connected = false;
                        $("#masterVolume").prop("disabled", true);
                    }

                    function handlePower(state) {
                        power_status = state;
                        if (state === true) {
                            $("#button_power_on").addClass("hide");
                            $("#button_power_off").removeClass("hide");
                        } else {
                            $("#button_power_on").removeClass("hide");
                            $("#button_power_off").addClass("hide");
                        }
                    }

                    $("#pane1").on("input", ".update_masterVolume", function () {
                        var value = $("#masterVolume").val();

                        wsSendCommand("masterVolume: " + parseInt((value * 0x00800000) / 100));
                    });

                    $("#pane1").on("click", ".connection", function () {
                        var stateStr = is_connected ? "0" : "1";
                        $.getJSON("http://" + host + "/connection?state=" + stateStr, function (obj) {
                            if (obj.connected !== undefined) {
                                handleConnection(obj.connected);
                            }
                        });
                    });

                    $("#pane1").on("click", ".mute", function () {});

                    $("#pane1").on("click", ".power", function () {
                        var stateStr = power_status ? "0" : "1";
                        $.getJSON("http://" + host + "/switch?state=" + stateStr, function (obj) {
                            if (obj.switch !== undefined) {
                                handlePower(obj.switch);
                            }
                        });
                    });

                    $("#pane1").on("click", ".nappi", function () {
                        console.log("nappi");

                        wsSendCommand("nappi");
                    });

                    function wsSendCommand(cmd) {
                        console.log("Send WebSocket command:", cmd);
                        if (ws_waiting == 0) {
                            connection.send(cmd);
                            ws_waiting++;
                        } else {
                            console.log("++++++++ WS call waiting, skip");
                        }
                    }

                    function heartbeat() {
                        if (!connection) return;
                        if (connection.readyState !== 1) return;
                        connection.send("heartbeat");
                        setTimeout(heartbeat, 10000);
                    }

                    init();
                });
            })(jQuery);
        </script>
    </body>
</html>
